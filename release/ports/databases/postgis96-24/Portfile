# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id: $

PortSystem          1.0
PortGroup           archcheck 1.0

name                postgis96-24
version             2.4.2
revision            0
categories          databases
platforms           darwin
maintainers         stromnov openmaintainer

description         PostGIS adds support for geographic objects to the PostgreSQL database

long_description \
    PostGIS adds support for geographic objects to the PostgreSQL \
    object-relational database.  In effect, PostGIS \"spatially enables\" \
    the PostgreSQL server, allowing it to be used as a backend spatial \
    database for geographic information systems (GIS), much like ESRI's \
    SDE or Oracle's Spatial extension.  PostGIS follows the OpenGIS \
    Simple Features Specification for SQL and will be submitted for \
    conformance testing at version 1.0.

homepage            http://postgis.refractions.net/
master_sites        http://download.osgeo.org/postgis/source/
patchfiles          patch-loader-Makefile.in.diff \
                    patch-raster-loader-Makefile.in.diff

distname            postgis-${version}
distfiles           postgis-${version}.tar.gz

checksums           md5     b6eebbb708cb0a67bbbe8edc9152780c \
                    sha1    490b7d11d5e01ce5369edba48989dd97f1077508 \
                    rmd160  b0b358866977cd418c38447ee5fccd27585f8ee5 \
                    sha256  23625bc99ed440d53a20225721095a3f5c653b62421c4d597c8038f0d7a321d9

depends_build \
    port:docbook-xsl \
    port:libxslt \
    port:ImageMagick

depends_lib \
    port:geos \
    port:proj \
    port:libiconv \
    port:libxml2

archcheck.files \
    lib/libgeos_c.dylib \
    lib/libiconv.dylib \
    lib/libproj.dylib \
    lib/libxml2.dylib

use_parallel_build  no

configure.args \
    --datadir=${prefix}/share/${name} \
    --with-projdir=${prefix} \
    --with-xsldir=${prefix}/share/xsl/docbook-xsl

configure.cflags-append \
    -Diconv=libiconv -Diconv_open=libiconv_open -Diconv_close=libiconv_close

build.target-append comments
build.args          ICONV_LDFLAGS='-L${prefix}/lib -liconv'

destroot.target-append comments-install

set postgresql_version 96
set short_version 2.3

post-patch {
    global postgresql_version

    set args {
         PGSQL_DOCDIR=${destroot}${prefix}/share/doc/postgresql${postgresql_version}
         PGSQL_MANDIR=${destroot}${prefix}/share/man
         PGSQL_SHAREDIR=${destroot}${prefix}/share/postgresql${postgresql_version}
    }

    reinplace -E "s|^DOCS =|#DOCS =|g" ${worksrcpath}/extensions/address_standardizer/Makefile.in
}
depends_lib-append  port:postgresql${postgresql_version}

variant sfcgal              description {Uses SFCGAL for 3D queries} {
    depends_lib-append      port:sfcgal
    configure.args-append   --with-sfcgal=${prefix}/bin/sfcgal-config
}

archcheck.files-append \
    lib/postgresql${postgresql_version}/libpq.dylib

configure.args-append   --includedir=${prefix}/include/postgresql${postgresql_version}/postgis-${short_version} \
                        --libdir=${prefix}/lib/postgresql${postgresql_version}/postgis-${short_version} \
                        --with-pgconfig=${prefix}/lib/postgresql${postgresql_version}/bin/pg_config

build.args-append   PGSQL_DOCDIR=${destroot}${prefix}/share/doc/postgresql${postgresql_version} \
                    PGSQL_MANDIR=${destroot}${prefix}/share/man

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     ${name}-(\\d+(?:\\.\\d+)*)\\.tar
